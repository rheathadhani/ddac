<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Clinical Notes</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" />
    <link rel="stylesheet" href="patient-index.css" />
    <style>
        .note-table th,
        .note-table td {
            padding: 15px;
            text-align: left;
        }

        .note-table th {
            background-color: #f8f9fa;
        }

        .note-actions {
            text-align: right;
        }

        .equal-height {
            display: flex;
            flex-wrap: wrap;
        }

        .equal-height>.col-md-6 {
            display: flex;
            flex-direction: column;
        }

        .equal-height .card {
            flex: 1;
        }

        .edit-mode .edit-note {
            display: none;
        }

        .edit-mode .save-note,
        .edit-mode .cancel-note {
            display: inline-block;
        }

        .save-note,
        .cancel-note {
            display: none;
        }
    </style>
</head>

<body>
    <div class="d-flex" id="wrapper">
        <div class="bg-dark border-right" id="sidebar-wrapper">
            <div class="list-group list-group-flush">
                <p class="bg-dark text-white mb-4 ml-4 mt-4"><strong>Telepsychiatry <br> Platform <span> +
                        </span></strong></p>
                <a href="psy-index.html" class="list-group-item list-group-item-action bg-dark text-white">Dashboard</a>
                <a href="psy-appointments.html"
                    class="list-group-item list-group-item-action bg-dark text-white">Patient Appointments</a>
                <a href="psy-med-pre.html" class="list-group-item list-group-item-action bg-dark text-white">Medicine
                    Prescription</a>
                <a href="psy-clinical.html" class="list-group-item list-group-item-action bg-dark text-white">Clinical
                    Notes</a>
                <a href="#" class="list-group-item list-group-item-action bg-dark text-white mt-auto">Sign Out</a>
            </div>
        </div>

        <div id="page-content-wrapper" class="w-100">
            <nav class="navbar navbar-expand-lg navbar-light bg-white">
                <button class="btn btn-dark" id="menu-toggle"> Menu </button>
            </nav>

            <div class="container-fluid">
                <div class="row">
                    <div class="col-12">
                        <div class="card mb-3">
                            <div class="card-header bg-dark text-white">
                                Manage Clinical Notes
                            </div>
                            <div class="card-body text-center">
                                <h4>Write and Manage Clinical Notes</h4>
                                <p>Select a patient to view or write notes</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row equal-height">
                    <div class="col-md-6">
                        <div class="card mb-3">
                            <div class="card-header bg-dark text-white">Patient List</div>
                            <div class="card-body">
                                <table class="table note-table">
                                    <thead>
                                        <tr>
                                            <th>Patient Name</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="patient-list">

                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="card mb-3">
                            <div class="card-header bg-dark text-white">Write Clinical Notes</div>
                            <div class="card-body">
                                <form id="notesForm">
                                    <!-- Add this hidden input field to store the patient ID -->
                                    <input type="hidden" id="selectedPatientId">

                                    <div class="form-group">
                                        <label for="selectedPatient">Selected Patient:</label>
                                        <input type="text" id="selectedPatient" class="form-control" readonly>
                                    </div>
                                    <div class="form-group">
                                        <label for="clinicalNotes">Clinical Notes:</label>
                                        <textarea id="clinicalNotes" class="form-control" rows="5"
                                            placeholder="Write clinical notes here..."></textarea>
                                    </div>
                                    <button type="button" class="btn btn-dark" id="saveNotes">Save Notes</button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-12">
                        <div class="card mb-3">
                            <div class="card-header bg-dark text-white">Existing Clinical Notes</div>
                            <div class="card-body">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Patient Name</th>
                                            <th>Clinical Notes</th>
                                            <th>Date</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="clinicalNotesTable">
                                        <tr>
                                            <!--Patient Nae-->
                                            <td>
                                                <div class="notes-content">
                                                    <!--Notes for patient--> <!--Several <p> tags-->
                                                </div>
                                            </td>
                                            <td>09/06/2024</td>
                                            <td>
                                                <button class="btn btn-info btn-sm edit-note">Edit</button>
                                                <button class="btn btn-danger btn-sm delete-note">Delete</button>
                                                <button class="btn btn-success btn-sm save-note">Save</button>
                                                <button class="btn btn-secondary btn-sm cancel-note">Cancel</button>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script>
        $(document).ready(function () {
            // Toggle sidebar menu
            $('#menu-toggle').click(function () {
                $('#wrapper').toggleClass('toggled');
            });

            // Function to fetch the patient list for clinical notes
            function fetchPatientList() {
                const psychiatristId = localStorage.getItem('psychiatristId'); // Get the psychiatrist ID from local storage

                // Use Axios to send a GET request to fetch the list of patients
                axios.get(`http://localhost:5500/api/psychiatrist/patient-list/${psychiatristId}`)
                    .then(function (response) {
                        const patients = response.data.patients;
                        const patientTableBody = $('#patient-list');

                        patientTableBody.empty(); // Clear any previous rows

                        // Loop through the list of patients and create table rows
                        patients.forEach(patient => {
                            const row = `
                                <tr>
                                        <td>${patient.fullName}</td>
                                        <td>
                                            <button class="btn btn-dark write-notes" data-patient-id="${patient.patientId}" data-patient-name="${patient.fullName}">Write Notes</button>
                                        </td>
                                    </tr>
                    `;
                            patientTableBody.append(row);
                        });
                    })
                    .catch(function (error) {
                        console.error('Error fetching patients:', error);
                        alert('Error fetching patients.');
                    });
            }

            // Call fetchPatientList on page load
            fetchPatientList();

            // Write notes for a selected patient
            $(document).on('click', '.write-notes', function () {
                const patientName = $(this).data('patient-name');
                const patientId = $(this).data('patient-id');

                //console.log(patientName);
                //console.log(patientId);
                // Set the selected patient name and ID in hidden fields
                $('#selectedPatient').val(patientName); // Display the name
                $('#selectedPatientId').val(patientId); // Store the ID in a hidden field
                $('#clinicalNotes').val(''); // Clear the textarea
            });

            $('#saveNotes').on('click', function () {
                const patientId = $('#selectedPatientId').val(); // Get the patient ID from the hidden field
                const notes = $('#clinicalNotes').val();
                const psychiatristId = localStorage.getItem('psychiatristId'); // Assuming the psychiatrist ID is stored in localStorage

                if (patientId && notes.trim()) {
                    // Use Axios to send a POST request to save the clinical notes
                    axios.post(`http://localhost:5500/api/psychiatrist/clinical-notes/${psychiatristId}`, {
                        patientId: patientId,  // Send the patient ID, not the name
                        noteText: notes
                    })
                        .then(function (response) {
                            console.log(patientId);
                            console.log(notes);
                            console.log(response)
                            alert(response.data.message); // Show success message
                            // Optionally, clear the input fields after saving the notes
                            $('#clinicalNotes').val('');
                        })
                        .catch(function (error) {
                            console.error('Error saving clinical notes:', error);
                            alert('There was an error saving the notes.');
                        });
                } else {
                    alert('Please select a patient and write some notes.');
                }
            });


        });

    </script>
</body>

</html>